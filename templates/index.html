<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBLEKA Gestor de Pedidos</title>
    <link rel="icon" href="{{ url_for('static', filename='img/logo_kRGB.png') }}" type="image/png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1.0.1">
</head>
<body>
    <div class="background-slideshow">
        <div class="slide" style="background-image: url('{{ url_for('static', filename='img/IMG_2804.jpg') }}');"></div>
        <div class="slide" style="background-image: url('{{ url_for('static', filename='img/IMG_2832.jpg') }}');"></div>
        <div class="slide" style="background-image: url('{{ url_for('static', filename='img/IMG_3158.JPG') }}');"></div>
    </div>
    <div class="overlay"></div>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <div class="mx-auto text-center">
                <a class="navbar-brand d-block" href="#">
                    <img src="{{ url_for('static', filename='img/logo_kRGB.png') }}" alt="Logo Robleka" class="main-logo">
                </a>
                <h1 class="main-title">ROBLEKA Gestor de Pedidos</h1>
            </div>
            <div class="ms-auto">
                <button id="darkModeToggle" class="btn btn-outline-secondary btn-sm">
                    <span class="light-mode-icon">‚òÄÔ∏è</span>
                    <span class="dark-mode-icon" style="display: none;">üåô</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
                    {% for category, message in messages %}
                        <div class="toast align-items-center text-white bg-{{ category }} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    {{ message }}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Fila de M√©tricas -->
        <div class="row mb-4 justify-content-center">
            <div class="col-md-4">
                <div class="metric-card text-white bg-success">
                    <h5>Total Facturado</h5>
                    <h2>{{ "%.2f" | format(total_facturado) }} ‚Ç¨</h2>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="metric-card text-white bg-danger">
                    <h5>Monto Pendiente</h5>
                    <h2>{{ "%.2f" | format(monto_pendiente) }} ‚Ç¨</h2>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Columna del Calendario y Gr√°ficos -->
            <div class="col-lg-3">
                <div id="calendario-container" class="mb-4">
                    <div id="calendario" data-dates='{{ fechas_pedidos_json | safe }}'></div>
                </div>
                <div id="charts-container">
                    <div class="chart-card mb-4">
                        <h5>Estado de Pedidos</h5>
                        <canvas id="estadoPedidosChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h5>Ingresos Mensuales</h5>
                        <canvas id="ingresosMensualesChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Columna de la Tabla de Pedidos -->
            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="table-title">Pedidos</h2>
                    <form action="{{ url_for('index') }}" method="get" class="d-flex align-items-center">
                        <input type="text" id="searchInput" name="search" class="form-control me-3" placeholder="Buscar por cliente, producto, estado..." value="{{ search_term }}">
                        <button type="submit" class="btn btn-info me-2">Buscar</button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-3">Limpiar</a>
                        <a href="{{ url_for('export_csv') }}" class="btn btn-success me-3">Exportar a CSV</a>
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addPedidoModal">
                            A√±adir Nuevo Pedido
                        </button>
                    </form>
                </div>
        
                <div class="table-responsive">
                    <table class="table table-hover" id="pedidosTable">
                        <thead>
                            <tr>
                                <th data-sort="cliente">Cliente</th>
                                <th data-sort="producto">Producto</th>
                                <th data-sort="precio">Precio</th>
                                <th>Pago</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Imagen</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidosTableBody">
                            {% for pedido in pedidos %}
                            <tr class="fila-pedido 
                                {% if pedido.estado_pedido == 'Pendiente' %}fila-pendiente
                                {% elif pedido.estado_pedido == 'En Progreso' %}fila-en-progreso
                                {% elif pedido.estado_pedido == 'Completado' %}fila-completado
                                {% endif %}
                            ">
                                <td>{{ pedido.nombre_cliente }}</td>
                                <td>{{ pedido.producto }}</td>
                                <td>{{ "%.2f" | format(pedido.precio) }} ‚Ç¨</td>
                                <td>{{ pedido.estado_pago }}</td>
                                <td class="estado-cell 
                                    {% if pedido.estado_pedido == 'Pendiente' %}estado-pendiente
                                    {% elif pedido.estado_pedido == 'En Progreso' %}estado-en-progreso
                                    {% elif pedido.estado_pedido == 'Completado' %}estado-completado
                                    {% endif %}
                                ">{{ pedido.estado_pedido }}</td>
                                <td>{{ pedido.fecha_creacion }}</td>
                                <td>
                                    {% if pedido.imagen_path %}
                                    <img src="{{ pedido.imagen_path }}" alt="Imagen del Producto" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                    {% else %}
                                    No hay imagen
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#viewPedidoModal"
                                        data-id="{{ pedido.id }}"
                                        data-nombre_cliente="{{ pedido.nombre_cliente }}"
                                        data-forma_contacto="{{ pedido.forma_contacto }}"
                                        data-contacto_detalle="{{ pedido.contacto_detalle }}"
                                        data-direccion_entrega="{{ pedido.direccion_entrega if pedido.direccion_entrega else '' }}"
                                        data-producto="{{ pedido.producto }}"
                                        data-detalles="{{ pedido.detalles }}"
                                        data-precio="{{ pedido.precio }}"
                                        data-anticipo="{{ pedido.anticipo }}"
                                        data-imagen_path="{{ pedido.imagen_path if pedido.imagen_path else '' }}"
                                        data-estado_pago="{{ pedido.estado_pago }}"
                                        data-estado_pedido="{{ pedido.estado_pedido }}"
                                        data-fecha_creacion="{{ pedido.fecha_creacion }}">
                                        Ver
                                    </button>
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editPedidoModal" 
                                        data-id="{{ pedido.id }}" 
                                        data-nombre_cliente="{{ pedido.nombre_cliente }}" 
                                        data-forma_contacto="{{ pedido.forma_contacto }}" 
                                        data-contacto_detalle="{{ pedido.contacto_detalle }}" 
                                        data-direccion_entrega="{{ pedido.direccion_entrega if pedido.direccion_entrega else '' }}"
                                        data-producto="{{ pedido.producto }}" 
                                        data-detalles="{{ pedido.detalles }}" 
                                        data-precio="{{ pedido.precio }}" 
                                        data-anticipo="{{ pedido.anticipo }}" 
                                        data-imagen_path="{{ pedido.imagen_path if pedido.imagen_path else '' }}" 
                                        data-estado_pago="{{ pedido.estado_pago }}" 
                                        data-estado_pedido="{{ pedido.estado_pedido }}">
                                        Editar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-btn" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-id="{{ pedido.id }}" data-nombre_cliente="{{ pedido.nombre_cliente }}">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8">No hay pedidos registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Controles de Paginaci√≥n -->
                {% if total_paginas > 1 %}
                <nav aria-label="Paginaci√≥n de pedidos">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('index', page=page-1, search=search_term) }}">Anterior</a>
                        </li>
                        {% for p in range(1, total_paginas + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('index', page=p, search=search_term) }}">{{ p }}</a>
                        </li>
                        {% endfor %}
                        <li class="page-item {% if page >= total_paginas %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('index', page=page+1, search=search_term) }}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal para A√±adir Pedido -->
    <div class="modal fade" id="addPedidoModal" tabindex="-1" aria-labelledby="addPedidoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPedidoModalLabel">A√±adir Nuevo Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPedidoForm" action="{{ url_for('add_pedido') }}" method="post" enctype="multipart/form-data">

                        <div class="form-step" id="step-1">
                            <label for="nombre_cliente" class="form-label">Nombre del Cliente</label>
                            <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required value="{{ form_data.nombre_cliente if form_data else '' }}">
                        </div>

                        <div class="form-step" id="step-2" style="display: none;">
                            <label for="forma_contacto" class="form-label">Forma de Contacto</label>
                            <select class="form-select" id="forma_contacto" name="forma_contacto" required>
                                <option value="WhatsApp" {% if form_data and form_data.forma_contacto == 'WhatsApp' %}selected{% endif %}>WhatsApp</option>
                                <option value="Instagram" {% if form_data and form_data.forma_contacto == 'Instagram' %}selected{% endif %}>Instagram</option>
                                <option value="Tel√©fono" {% if form_data and form_data.forma_contacto == 'Tel√©fono' %}selected{% endif %}>Tel√©fono</option>
                                <option value="Email" {% if form_data and form_data.forma_contacto == 'Email' %}selected{% endif %}>Email</option>
                                <option value="Otro" {% if form_data and form_data.forma_contacto == 'Otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </div>

                        <div class="form-step" id="step-3" style="display: none;">
                            <label for="contacto_detalle" class="form-label">Detalle del Contacto (Usuario, n√∫mero, etc.)</label>
                            <input type="text" class="form-control" id="contacto_detalle" name="contacto_detalle" value="{{ form_data.contacto_detalle if form_data else '' }}">
                        </div>

                        <div class="form-step" id="step-4" style="display: none;">
                            <label for="direccion_entrega" class="form-label">Direcci√≥n de Entrega</label>
                            <textarea class="form-control" id="direccion_entrega" name="direccion_entrega" rows="2">{{ form_data.direccion_entrega if form_data else '' }}</textarea>
                        </div>

                        <div class="form-step" id="step-5" style="display: none;">
                            <label for="producto" class="form-label">Producto</label>
                            <input type="text" class="form-control" id="producto" name="producto" required value="{{ form_data.producto if form_data else '' }}">
                        </div>

                        <div class="form-step" id="step-6" style="display: none;">
                            <label for="detalles" class="form-label">Detalles del Pedido</label>
                            <textarea class="form-control" id="detalles" name="detalles" rows="3">{{ form_data.detalles if form_data else '' }}</textarea>
                        </div>

                        <div class="form-step" id="step-7" style="display: none;">
                            <label for="precio" class="form-label">Precio Total (‚Ç¨)</label>
                            <input type="number" class="form-control" id="precio" name="precio" step="0.01" required value="{{ form_data.precio if form_data else '0.00' }}">
                        </div>

                        <div class="form-step" id="step-8" style="display: none;">
                            <label for="anticipo" class="form-label">Anticipo (‚Ç¨)</label>
                            <input type="number" class="form-control" id="anticipo" name="anticipo" step="0.01" value="{{ form_data.anticipo if form_data else '0.00' }}">
                        </div>

                        

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Anterior</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Siguiente</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" form="addPedidoForm" style="display: none;">Finalizar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Pedido -->
    <div class="modal fade" id="editPedidoModal" tabindex="-1" aria-labelledby="editPedidoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPedidoModalLabel">Editar Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPedidoForm" method="post" enctype="multipart/form-data">
                        <input type="hidden" id="edit_id" name="id" value="{{ edit_form_data.id if edit_form_data else '' }}">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Informaci√≥n del Cliente</h5>
                                <div class="mb-3">
                                    <label for="edit_nombre_cliente" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="edit_nombre_cliente" name="nombre_cliente" required value="{{ edit_form_data.nombre_cliente if edit_form_data else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="edit_forma_contacto" class="form-label">Forma de Contacto</label>
                                    <select class="form-select" id="edit_forma_contacto" name="forma_contacto" required>
                                        <option value="WhatsApp" {% if edit_form_data and edit_form_data.forma_contacto == 'WhatsApp' %}selected{% endif %}>WhatsApp</option>
                                        <option value="Instagram" {% if edit_form_data and edit_form_data.forma_contacto == 'Instagram' %}selected{% endif %}>Instagram</option>
                                        <option value="Tel√©fono" {% if edit_form_data and edit_form_data.forma_contacto == 'Tel√©fono' %}selected{% endif %}>Tel√©fono</option>
                                        <option value="Email" {% if edit_form_data and edit_form_data.forma_contacto == 'Email' %}selected{% endif %}>Email</option>
                                        <option value="Otro" {% if edit_form_data and edit_form_data.forma_contacto == 'Otro' %}selected{% endif %}>Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_contacto_detalle" class="form-label">Detalle</label>
                                    <input type="text" class="form-control" id="edit_contacto_detalle" name="contacto_detalle" value="{{ edit_form_data.contacto_detalle if edit_form_data else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="edit_direccion_entrega" class="form-label">Direcci√≥n de Entrega</label>
                                    <textarea class="form-control" id="edit_direccion_entrega" name="direccion_entrega" rows="2">{{ edit_form_data.direccion_entrega if edit_form_data else '' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Detalles del Pedido</h5>
                                <div class="mb-3">
                                    <label for="edit_producto" class="form-label">Producto</label>
                                    <input type="text" class="form-control" id="edit_producto" name="producto" required value="{{ edit_form_data.producto if edit_form_data else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="edit_detalles" class="form-label">Detalles</label>
                                    <textarea class="form-control" id="edit_detalles" name="detalles" rows="3">{{ edit_form_data.detalles if edit_form_data else '' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_estado_pedido" class="form-label">Estado del Pedido</label>
                                    <select class="form-select" id="edit_estado_pedido" name="estado_pedido" required>
                                        <option value="Pendiente" {% if edit_form_data and edit_form_data.estado_pedido == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="En Progreso" {% if edit_form_data and edit_form_data.estado_pedido == 'En Progreso' %}selected{% endif %}>En Progreso</option>
                                        <option value="Completado" {% if edit_form_data and edit_form_data.estado_pedido == 'Completado' %}selected{% endif %}>Completado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Informaci√≥n de Pago</h5>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="edit_precio" class="form-label">Precio Total (‚Ç¨)</label>
                                        <input type="number" class="form-control" id="edit_precio" name="precio" step="0.01" required value="{{ edit_form_data.precio if edit_form_data else '0.00' }}">
                                    </div>
                                    <div class="col-6">
                                        <label for="edit_anticipo" class="form-label">Anticipo (‚Ç¨)</label>
                                        <input type="number" class="form-control" id="edit_anticipo" name="anticipo" step="0.01" value="{{ edit_form_data.anticipo if edit_form_data else '0.00' }}">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <strong>Monto Restante: </strong>
                                    <span id="edit_monto_restante_display" class="fw-bold">0.00</span> ‚Ç¨
                                </div>
                                
                            </div>
                            <div class="col-md-6">
                                <h5>Imagen del Producto</h5>
                                <div class="mb-3">
                                    <label for="imagen" class="form-label">Subir Nueva Imagen</label>
                                    <input class="form-control" type="file" id="imagen" name="imagen">
                                </div>
                                <div id="current_image_preview">
                                    <!-- La imagen actual se mostrar√° aqu√≠ -->
                                </div>
                                <input type="hidden" id="current_imagen_path" name="current_imagen_path" value="{{ edit_form_data.imagen_path if edit_form_data else '' }}">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" form="editPedidoForm">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Pedido (Solo Lectura) -->
    <div class="modal fade" id="viewPedidoModal" tabindex="-1" aria-labelledby="viewPedidoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewPedidoModalLabel">Detalles del Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Informaci√≥n del Cliente</h5>
                            <p><strong>Nombre:</strong> <span id="view_nombre_cliente"></span></p>
                            <p><strong>Contacto:</strong> <span id="view_forma_contacto"></span> (<span id="view_contacto_detalle"></span>)</p>
                            <p><strong>Direcci√≥n:</strong> <span id="view_direccion_entrega"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h5>Detalles del Pedido</h5>
                            <p><strong>Producto:</strong> <span id="view_producto"></span></p>
                            <p><strong>Detalles:</strong> <span id="view_detalles"></span></p>
                            <p><strong>Estado:</strong> <span id="view_estado_pedido"></span></p>
                            <p><strong>Fecha Creaci√≥n:</strong> <span id="view_fecha_creacion"></span></p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Informaci√≥n de Pago</h5>
                            <p><strong>Precio Total:</strong> <span id="view_precio"></span> ‚Ç¨</p>
                            <p><strong>Anticipo:</strong> <span id="view_anticipo"></span> ‚Ç¨</p>
                            <p><strong>Monto Restante:</strong> <span id="view_monto_restante"></span> ‚Ç¨</p>
                            <p><strong>Estado Pago:</strong> <span id="view_estado_pago"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h5>Imagen del Producto</h5>
                            <div id="view_imagen_preview">
                                <!-- La imagen se insertar√° aqu√≠ mediante JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¬øEst√°s seguro de que quieres eliminar el pedido de <strong id="delete_cliente_nombre"></strong>?
                    Esta acci√≥n no se puede deshacer.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="deleteForm" method="post" action="">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS y Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script> <!-- Idioma Espa√±ol -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Datos para los gr√°ficos (JSON incrustado) -->
    <script type="application/json" id="chart-estados-data">{{ chart_estados_data | safe }}</script>
    <script type="application/json" id="chart-ingresos-data">{{ chart_ingresos_data | safe }}</script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

        {% if form_data %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var addPedidoModal = new bootstrap.Modal(document.getElementById('addPedidoModal'));
            addPedidoModal.show();
        });
    </script>
    {% endif %}

    {% if open_edit_modal and edit_form_data %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var editPedidoModal = new bootstrap.Modal(document.getElementById('editPedidoModal'));
            // Rellenar el modal de edici√≥n con los datos que vienen del servidor
            // Esto es necesario porque el modal se abre autom√°ticamente y no pasa por el evento show.bs.modal
            const data = {{ edit_form_data | tojson }};
            document.getElementById('edit_id').value = data.id;
            document.getElementById('edit_nombre_cliente').value = data.nombre_cliente;
            document.getElementById('edit_forma_contacto').value = data.forma_contacto;
            document.getElementById('edit_contacto_detalle').value = data.contacto_detalle;
            document.getElementById('edit_direccion_entrega').value = data.direccion_entrega;
            document.getElementById('edit_producto').value = data.producto;
            document.getElementById('edit_detalles').value = data.detalles;
            document.getElementById('edit_precio').value = parseFloat(data.precio).toFixed(2);
            document.getElementById('edit_anticipo').value = parseFloat(data.anticipo).toFixed(2);
            document.getElementById('edit_estado_pedido').value = data.estado_pedido;
            document.getElementById('current_imagen_path').value = data.imagen_path;

            var currentImagePreview = document.getElementById('current_image_preview');
            if (currentImagePreview) {
                currentImagePreview.innerHTML = '';
                if (data.imagen_path) {
                    var img = document.createElement('img');
                    img.src = data.imagen_path;
                    img.alt = 'Imagen Actual';
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'cover';
                    currentImagePreview.appendChild(img);
                } else {
                    currentImagePreview.textContent = 'No hay imagen actual.';
                }
            }

            // Actualizar monto restante
            const precioInput = document.getElementById('edit_precio');
            const anticipoInput = document.getElementById('edit_anticipo');
            const montoRestanteDisplay = document.getElementById('edit_monto_restante_display');
            if (precioInput && anticipoInput && montoRestanteDisplay) {
                var currentPrecio = parseFloat(precioInput.value) || 0;
                var currentAnticipo = parseFloat(anticipoInput.value) || 0;
                montoRestanteDisplay.textContent = (currentPrecio - currentAnticipo).toFixed(2);
            }

            editPedidoModal.show();
        });
    </script>
    {% endif %}
</body>
</html>